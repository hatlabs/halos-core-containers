#!/bin/bash
# Reload OIDC clients for Authelia
# Called automatically when files in /etc/halos/oidc-clients.d/ change
# Can also be run manually: /usr/bin/reload-oidc-clients

set -e

PACKAGE_NAME="halos-core-containers"
ETC_DIR="/etc/container-apps/${PACKAGE_NAME}"
CONTAINER_DATA_ROOT="/var/lib/container-apps/${PACKAGE_NAME}"
AUTHELIA_DATA="${CONTAINER_DATA_ROOT}/authelia"
OIDC_CLIENTS_DIR="/etc/halos/oidc-clients.d"
AUTHELIA_OIDC_FILE="${AUTHELIA_DATA}/oidc-clients.yml"
AUTHELIA_SECRETS_FILE="${AUTHELIA_DATA}/secrets.env"

# Load secrets
if [ ! -f "${AUTHELIA_SECRETS_FILE}" ]; then
    echo "ERROR: Authelia secrets not found. Run halos-core-containers first."
    exit 1
fi
. "${AUTHELIA_SECRETS_FILE}"

OIDC_PRIVATE_KEY=$(cat "${AUTHELIA_DATA}/oidc_private_key.pem")

# Auto-detect domain from hostname
HOSTNAME_SHORT=$(hostname -s 2>/dev/null || hostname | cut -d. -f1)
HALOS_DOMAIN="${HOSTNAME_SHORT}.local"

echo "Reloading OIDC clients for ${HALOS_DOMAIN}..."

# Hash a plaintext secret using Authelia's CLI
hash_client_secret() {
    local plaintext="$1"
    local hash_output
    hash_output=$(docker run --rm authelia/authelia:4.39 authelia crypto hash generate pbkdf2 \
        --variant sha512 \
        --password "${plaintext}" 2>/dev/null)
    if [ $? -ne 0 ]; then
        return 1
    fi
    echo "$hash_output" | grep 'Digest:' | sed 's/Digest: //'
}

# Merge OIDC client snippets
client_count=0
clients_yaml=""

for snippet in "${OIDC_CLIENTS_DIR}"/*.yml; do
    [ -e "$snippet" ] || continue
    snippet_name=$(basename "$snippet")
    echo "  Processing: ${snippet_name}"

    # Read fields from snippet
    client_id=$(grep -E '^client_id:' "$snippet" | sed 's/client_id:[[:space:]]*//' | tr -d "'\"")
    client_name=$(grep -E '^client_name:' "$snippet" | sed 's/client_name:[[:space:]]*//' | tr -d "'\"")
    client_secret_file=$(grep -E '^client_secret_file:' "$snippet" | sed 's/client_secret_file:[[:space:]]*//' | tr -d "'\"")
    consent_mode=$(grep -E '^consent_mode:' "$snippet" | sed 's/consent_mode:[[:space:]]*//' | tr -d "'\"")
    token_auth_method=$(grep -E '^token_endpoint_auth_method:' "$snippet" | sed 's/token_endpoint_auth_method:[[:space:]]*//' | tr -d "'\"")

    [ -z "$client_id" ] && { echo "  WARNING: Skipping ${snippet_name} - missing client_id"; continue; }

    # Read and hash client secret
    client_secret_hash=""
    if [ -n "$client_secret_file" ] && [ -f "$client_secret_file" ]; then
        plaintext_secret=$(cat "$client_secret_file")
        if ! client_secret_hash=$(hash_client_secret "$plaintext_secret"); then
            echo "  ERROR: Failed to hash client secret for ${snippet_name}"
            continue
        fi
    else
        echo "  WARNING: Skipping ${snippet_name} - client_secret_file not found: ${client_secret_file}"
        continue
    fi

    # Extract redirect_uris
    redirect_uris=""
    in_redirect=false
    while IFS= read -r line; do
        if echo "$line" | grep -qE '^redirect_uris:'; then
            in_redirect=true
            continue
        fi
        if $in_redirect; then
            if echo "$line" | grep -qE '^[[:space:]]+-'; then
                uri=$(echo "$line" | sed "s/^[[:space:]]*-[[:space:]]*//" | tr -d "'\"")
                uri="${uri//\$\{HALOS_DOMAIN\}/${HALOS_DOMAIN}}"
                redirect_uris="${redirect_uris}          - '${uri}'\n"
            elif echo "$line" | grep -qE '^[a-z_]+:'; then
                break
            fi
        fi
    done < "$snippet"

    # Extract scopes
    scopes_line=$(grep -E '^scopes:' "$snippet")
    scopes=""
    if echo "$scopes_line" | grep -qE '\[.*\]'; then
        scopes=$(echo "$scopes_line" | sed 's/scopes:[[:space:]]*//')
    else
        scopes="[openid, profile, email]"
    fi

    # Build client YAML
    clients_yaml="${clients_yaml}      - client_id: ${client_id}
        client_name: '${client_name:-${client_id}}'
        client_secret: '${client_secret_hash}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
$(echo -e "${redirect_uris}" | sed '/^$/d')
        scopes: ${scopes}
        consent_mode: ${consent_mode:-implicit}
        token_endpoint_auth_method: ${token_auth_method:-client_secret_post}
"
    client_count=$((client_count + 1))
done

if [ $client_count -eq 0 ]; then
    echo "  No OIDC client snippets found - OIDC will be disabled"
    cat > "${AUTHELIA_OIDC_FILE}" << 'EOF'
# Authelia OIDC Configuration - No clients configured
EOF
else
    echo "  Merged ${client_count} OIDC client(s)"
    indented_key=$(echo "${OIDC_PRIVATE_KEY}" | awk 'NR==1 {print} NR>1 {print "          " $0}')

    cat > "${AUTHELIA_OIDC_FILE}" << EOF
# Authelia OIDC Configuration
# Auto-generated by reload-oidc-clients
identity_providers:
  oidc:
    hmac_secret: '${OIDC_HMAC_SECRET}'
    jwks:
      - key: |
          ${indented_key}
    clients:
${clients_yaml}
EOF
fi
chmod 600 "${AUTHELIA_OIDC_FILE}"

# Restart Authelia to pick up new configuration
echo "Restarting Authelia..."
cd /var/lib/container-apps/${PACKAGE_NAME}
docker compose restart authelia

echo "OIDC clients reloaded successfully"
