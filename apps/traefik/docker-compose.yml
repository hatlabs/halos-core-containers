services:
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    # Wait for Authelia before starting Traefik to avoid HTTP 500 during boot
    entrypoint: ["/wait-for-authelia.sh"]
    command: ["traefik"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./assets/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./assets/wait-for-authelia.sh:/wait-for-authelia.sh:ro
      # Dynamic middleware directory - apps drop their files here
      - /etc/halos/traefik-dynamic.d:/etc/traefik/dynamic:ro
      # Generic routing declarations - read by prestart to generate labels
      - /etc/halos/routing.d:/etc/halos/routing.d:ro
      - ${CONTAINER_DATA_ROOT}/acme.json:/acme.json
      # Persistent self-signed TLS certificates
      - ${CONTAINER_DATA_ROOT}/certs:/certs:ro
    extra_hosts:
      # Required for host networking apps (Traefik routes to host IP)
      - "host.docker.internal:host-gateway"
    networks:
      - proxy
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

networks:
  proxy:
    name: halos-proxy-network
    driver: bridge
