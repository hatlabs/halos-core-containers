services:
  homarr:
    # Using hatlabs fork until homarr-labs/homarr#4372 is merged
    image: ghcr.io/hatlabs/homarr:api-key-test
    container_name: homarr
    restart: unless-stopped
    entrypoint: ["/custom-entrypoint.sh"]
    command: ["sh", "run.sh"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # Allow Homarr to resolve auth subdomain for OIDC (mDNS doesn't work in containers)
      - "auth.${HALOS_DOMAIN}:host-gateway"
    environment:
      - SECRET_ENCRYPTION_KEY=${SECRET_ENCRYPTION_KEY}
      # Tell NextAuth the canonical HTTPS URL (behind Traefik proxy)
      - NEXTAUTH_URL=https://${HALOS_DOMAIN}
      # SECURITY: Disables TLS verification for ALL Node.js HTTPS requests.
      # Required for self-signed Traefik certs. Acceptable for local-only device.
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      # SSO/OIDC configuration (optional, set AUTH_PROVIDERS=oidc to enable)
      - AUTH_PROVIDERS=${AUTH_PROVIDERS:-}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_OIDC_ISSUER=${AUTH_OIDC_ISSUER}
      - AUTH_OIDC_CLIENT_ID=${AUTH_OIDC_CLIENT_ID:-}
      - AUTH_OIDC_CLIENT_SECRET=${AUTH_OIDC_CLIENT_SECRET:-}
      - AUTH_OIDC_CLIENT_NAME=${AUTH_OIDC_CLIENT_NAME:-}
      - AUTH_OIDC_SCOPE_OVERWRITE=${AUTH_OIDC_SCOPE_OVERWRITE:-}
      - AUTH_OIDC_FORCE_USERINFO=${AUTH_OIDC_FORCE_USERINFO:-}
      - AUTH_OIDC_ENABLE_DANGEROUS_ACCOUNT_LINKING=${AUTH_OIDC_ENABLE_DANGEROUS_ACCOUNT_LINKING:-}
      - AUTH_LOGOUT_REDIRECT_URL=${AUTH_LOGOUT_REDIRECT_URL}
    ports:
      # Expose to localhost only for homarr-container-adapter
      - "127.0.0.1:7575:7575"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONTAINER_DATA_ROOT}/data:/appdata
      # Custom entrypoint that patches nginx to serve local assets
      - ./assets/custom-entrypoint.sh:/custom-entrypoint.sh:ro
      # Asset volumes (served via patched nginx)
      - /usr/share/pixmaps:/usr/share/pixmaps:ro
      - /usr/share/halos-homarr-branding:/usr/share/halos-homarr-branding:ro
      - /var/lib/container-apps:/var/lib/container-apps:ro
    networks:
      - proxy
    labels:
      - traefik.enable=true
      # HTTP router (redirects to HTTPS)
      - traefik.http.routers.homarr.rule=Host(`${HALOS_DOMAIN}`)
      - traefik.http.routers.homarr.entrypoints=web
      - traefik.http.routers.homarr.middlewares=redirect-to-https@file
      # HTTPS router
      - traefik.http.routers.homarr-secure.rule=Host(`${HALOS_DOMAIN}`)
      - traefik.http.routers.homarr-secure.entrypoints=websecure
      - traefik.http.routers.homarr-secure.tls=true
      - traefik.http.services.homarr.loadbalancer.server.port=7575
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

networks:
  proxy:
    name: halos-proxy-network
    external: true
