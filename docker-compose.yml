services:
  traefik:
    image: traefik:v3.6.8
    container_name: traefik
    init: true
    restart: unless-stopped
    depends_on:
      authelia:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./assets/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      # Dynamic middleware directory - apps drop their files here
      - /etc/halos/traefik-dynamic.d:/etc/traefik/dynamic:ro
      # Generic routing declarations - read by prestart to generate labels
      - /etc/halos/routing.d:/etc/halos/routing.d:ro
      - ${CONTAINER_DATA_ROOT}/traefik/acme.json:/acme.json
      # Persistent self-signed TLS certificates
      - ${CONTAINER_DATA_ROOT}/traefik/certs:/certs:ro
    extra_hosts:
      # Required for host networking apps (Traefik routes to host IP)
      - "host.docker.internal:host-gateway"
    networks:
      - proxy
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

  authelia:
    image: authelia/authelia:4.39.15
    container_name: authelia
    init: true
    restart: unless-stopped
    depends_on:
      authelia-valkey:
        condition: service_healthy
    volumes:
      - ${CONTAINER_DATA_ROOT}/authelia:/config
    environment:
      - TZ=${TZ:-UTC}
      # Load base configuration and OIDC clients (merged by Authelia)
      - X_AUTHELIA_CONFIG=/config/configuration.yml,/config/oidc-clients.yml
    healthcheck:
      test: ["CMD-SHELL", "/app/healthcheck.sh"]
      interval: 2s
      timeout: 3s
      start_period: 1s
      retries: 3
    networks:
      - proxy
      - authelia-internal
    labels:
      - traefik.enable=true
      # HTTP router (redirects to HTTPS)
      - traefik.http.routers.authelia.rule=Host(`auth.${HALOS_DOMAIN}`)
      - traefik.http.routers.authelia.entrypoints=web
      - traefik.http.routers.authelia.middlewares=redirect-to-https@file
      # HTTPS router
      - traefik.http.routers.authelia-secure.rule=Host(`auth.${HALOS_DOMAIN}`)
      - traefik.http.routers.authelia-secure.entrypoints=websecure
      - traefik.http.routers.authelia-secure.tls=true
      - traefik.http.services.authelia.loadbalancer.server.port=9091
      # mDNS subdomain - halos-mdns-publisher publishes auth.${HALOS_DOMAIN}
      - halos.subdomain=auth
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

  authelia-valkey:
    image: valkey/valkey:9.0.2-alpine
    container_name: authelia-valkey
    init: true
    restart: unless-stopped
    volumes:
      - ${CONTAINER_DATA_ROOT}/authelia/valkey:/data
    command: >-
      valkey-server
      --save ""
      --appendonly yes
      --requirepass "${REDIS_PASSWORD}"
      --loglevel warning
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "${REDIS_PASSWORD}", "--no-auth-warning", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - authelia-internal
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

  homarr:
    image: ghcr.io/homarr-labs/homarr:v1.53.2
    container_name: homarr
    init: true
    restart: unless-stopped
    depends_on:
      - traefik
    entrypoint: ["/custom-entrypoint.sh"]
    command: ["bash", "run.sh"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
      # Allow Homarr to resolve auth subdomain for OIDC (mDNS doesn't work in containers)
      - "auth.${HALOS_DOMAIN}:host-gateway"
    environment:
      - SECRET_ENCRYPTION_KEY=${SECRET_ENCRYPTION_KEY}
      # Tell NextAuth the canonical HTTPS URL (behind Traefik proxy)
      - NEXTAUTH_URL=https://${HALOS_DOMAIN}
      # SECURITY: Disables TLS verification for ALL Node.js HTTPS requests.
      # Required for self-signed Traefik certs. Acceptable for local-only device.
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      # SSO/OIDC configuration (optional, set AUTH_PROVIDERS=oidc to enable)
      - AUTH_PROVIDERS=${AUTH_PROVIDERS:-}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_OIDC_ISSUER=${AUTH_OIDC_ISSUER}
      - AUTH_OIDC_CLIENT_ID=${AUTH_OIDC_CLIENT_ID:-}
      - AUTH_OIDC_CLIENT_SECRET=${AUTH_OIDC_CLIENT_SECRET:-}
      - AUTH_OIDC_CLIENT_NAME=${AUTH_OIDC_CLIENT_NAME:-}
      - AUTH_OIDC_SCOPE_OVERWRITE=${AUTH_OIDC_SCOPE_OVERWRITE:-}
      - AUTH_OIDC_FORCE_USERINFO=${AUTH_OIDC_FORCE_USERINFO:-}
      - AUTH_OIDC_ENABLE_DANGEROUS_ACCOUNT_LINKING=${AUTH_OIDC_ENABLE_DANGEROUS_ACCOUNT_LINKING:-}
      - AUTH_LOGOUT_REDIRECT_URL=${AUTH_LOGOUT_REDIRECT_URL}
      # Auto-redirect to OIDC provider on login page for seamless SSO
      - AUTH_OIDC_AUTO_LOGIN=true
      # Suppress external network requests (icon updates, analytics, update checks)
      - NO_EXTERNAL_CONNECTION=true
    ports:
      # Expose to localhost only for homarr-container-adapter
      - "127.0.0.1:7575:7575"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONTAINER_DATA_ROOT}/homarr/data:/appdata
      # Custom entrypoint that patches nginx to serve local assets
      - ./assets/homarr/custom-entrypoint.sh:/custom-entrypoint.sh:ro
      # Asset volumes (served via patched nginx)
      - /usr/share/pixmaps:/usr/share/pixmaps:ro
      - /usr/share/halos-homarr-branding:/usr/share/halos-homarr-branding:ro
      - /var/lib/container-apps:/var/lib/container-apps:ro
    networks:
      - proxy
    labels:
      - traefik.enable=true
      # HTTP router (redirects to HTTPS)
      - traefik.http.routers.homarr.rule=Host(`${HALOS_DOMAIN}`)
      - traefik.http.routers.homarr.entrypoints=web
      - traefik.http.routers.homarr.middlewares=redirect-to-https@file
      # HTTPS router - Homarr handles auth via OIDC (no ForwardAuth needed)
      - traefik.http.routers.homarr-secure.rule=Host(`${HALOS_DOMAIN}`)
      - traefik.http.routers.homarr-secure.entrypoints=websecure
      - traefik.http.routers.homarr-secure.tls=true
      - traefik.http.services.homarr.loadbalancer.server.port=7575
      # mDNS subdomain - empty means root domain (${HALOS_DOMAIN})
      - halos.subdomain=
    logging:
      driver: journald
      options:
        tag: "{{.Name}}"

networks:
  proxy:
    name: halos-proxy-network
    driver: bridge
  authelia-internal:
    # Internal network for Authelia <-> Valkey communication only
    driver: bridge
    internal: true
